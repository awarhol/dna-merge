import { describe, it, expect } from 'vitest'
import {
  detectFormat,
  validateGenotype,
  parseAncestryFileAsync,
  parseMyHeritageFileAsync,
  parseLivingDNAFileAsync,
  mergeSnpsAsync,
  generateMyHeritageCsv,
  generateAncestryCsv,
  generateLogFile,
  normalizeGenotypeForFormat,
} from './dna'

const ANCESTRY_SAMPLE = `#AncestryDNA raw data download
#This file was generated by AncestryDNA at: 01/17/2026 16:39:45 UTC
rsid	chromosome	position	allele1	allele2
rs3131972	1	752721	G	G
rs114525117	1	759036	G	G
rs11240777	1	798959	G	G
rs4475691	1	846808	T	C
rs7537756	1	854250	A	G`

const MYHERITAGE_SAMPLE = `##fileformat=MyHeritage
##format=MHv1.0
##chip=GSA
RSID,CHROMOSOME,POSITION,RESULT
"rs3131972","1","752721","GG"
"rs114525117","1","759036","GG"
"rs11240777","1","798959","GG"
"rs4475691","1","846808","CT"
"rs2341354","1","918573","AG"`

const LIVINGDNA_SAMPLE = `# Living DNA customer genotype data download file version: 1.1.0
# File creation date: 1-24-2025
# Genotype chip: Sirius
# The content of this file is subject to updates and changes depending on the time of download.
# Human Genome Reference Build 37 (GRCh37.p13).
# Genotypes are presented on the forward strand.
#
# rsid	chromosome	position	genotype
rs3131972	1	752721	AG
rs114525117	1	759036	GG
rs141175086	1	780397	CC
AX-33748877	22	51162850	CT
rs143357798	22	51193012	CC`

describe('detectFormat', () => {
  it('should detect Ancestry format from sample file', async () => {
    expect(detectFormat(ANCESTRY_SAMPLE)).toBe('ancestry')
  })

  it('should detect MyHeritage format from sample file', async () => {
    expect(detectFormat(MYHERITAGE_SAMPLE)).toBe('myheritage')
  })

  it('should detect LivingDNA format from sample file', async () => {
    expect(detectFormat(LIVINGDNA_SAMPLE)).toBe('livingdna')
  })

  it('should return unknown for empty content', async () => {
    expect(detectFormat('')).toBe('unknown')
  })

  it('should return unknown for invalid format', async () => {
    expect(detectFormat('random text\nno valid format')).toBe('unknown')
  })
})

describe('validateGenotype', () => {
  it('should validate standard nucleotide pairs', async () => {
    expect(validateGenotype('AA')).toBe(true)
    expect(validateGenotype('AT')).toBe(true)
    expect(validateGenotype('CG')).toBe(true)
    expect(validateGenotype('TT')).toBe(true)
  })

  it('should validate special markers (lenient mode)', async () => {
    expect(validateGenotype('--')).toBe(true)
    expect(validateGenotype('00')).toBe(true)
    expect(validateGenotype('DD')).toBe(true)
    expect(validateGenotype('II')).toBe(true)
  })

  it('should reject invalid genotypes', async () => {
    expect(validateGenotype('XY')).toBe(false)
    expect(validateGenotype('ZZ')).toBe(false)
    expect(validateGenotype('12')).toBe(false)
    expect(validateGenotype('A')).toBe(false)
  })

  it('should be case insensitive', async () => {
    expect(validateGenotype('aa')).toBe(true)
    expect(validateGenotype('Tc')).toBe(true)
  })

  it('should validate DI and ID genotypes', async () => {
    expect(validateGenotype('DI')).toBe(true)
    expect(validateGenotype('ID')).toBe(true)
    expect(validateGenotype('di')).toBe(true)
    expect(validateGenotype('id')).toBe(true)
  })
})

describe('mergeSnps', () => {
  const defaultOptions = { preferredFile: 1 as const, fillMissing: true }

  it('should merge SNPs from two files without duplicates', async () => {
    const file1 = await parseAncestryFileAsync(ANCESTRY_SAMPLE, 1)
    const file2 = await parseMyHeritageFileAsync(MYHERITAGE_SAMPLE, 2)

    const result = await mergeSnpsAsync(file1.snps, file2.snps, defaultOptions)

    expect(result.mergedSnps.length).toBeGreaterThan(0)
    expect(result.mergedSnps.length).toBeLessThanOrEqual(file1.snps.length + file2.snps.length)
  })

  it('should detect conflicts when same RSID has different genotypes', async () => {
    const file1Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AA', sourceFile: 1 as const },
    ]
    const file2Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AC', sourceFile: 2 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, file2Snps, defaultOptions)

    expect(result.conflicts).toHaveLength(1)
    expect(result.conflicts[0].file1Genotype).toBe('AA')
    expect(result.conflicts[0].file2Genotype).toBe('AC')
    expect(result.conflicts[0].chosenGenotype).toBe('AA')
    expect(result.conflicts[0].resolutionReason).toBe('Preferred File 1')
  })

  it('should prioritize Ancestry when preferred', async () => {
    const file1Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AA', sourceFile: 1 as const },
    ]
    const file2Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AC', sourceFile: 2 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, file2Snps, {
      preferredFile: 1,
      fillMissing: false,
    })

    const mergedSnp = result.mergedSnps.find(s => s.rsid === 'rs123')
    expect(mergedSnp?.genotype).toBe('AA')
    expect(result.conflicts[0].resolutionReason).toBe('Preferred File 1')
  })

  it('should prioritize MyHeritage when preferred', async () => {
    const file1Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AA', sourceFile: 1 as const },
    ]
    const file2Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AC', sourceFile: 2 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, file2Snps, {
      preferredFile: 2,
      fillMissing: false,
    })

    const mergedSnp = result.mergedSnps.find(s => s.rsid === 'rs123')
    expect(mergedSnp?.genotype).toBe('AC')
    expect(result.conflicts[0].resolutionReason).toBe('Preferred File 2')
  })

  it('should fill missing values when fillMissing is true', async () => {
    const file1Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: '--', sourceFile: 1 as const },
    ]
    const file2Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AC', sourceFile: 2 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, file2Snps, {
      preferredFile: 1,
      fillMissing: true,
    })

    const mergedSnp = result.mergedSnps.find(s => s.rsid === 'rs123')
    expect(mergedSnp?.genotype).toBe('AC')
    expect(result.conflicts[0].resolutionReason).toBe('Filled Missing from File 2')
  })

  it('should not fill missing values when fillMissing is false', async () => {
    const file1Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: '--', sourceFile: 1 as const },
    ]
    const file2Snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AC', sourceFile: 2 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, file2Snps, {
      preferredFile: 1,
      fillMissing: false,
    })

    const mergedSnp = result.mergedSnps.find(s => s.rsid === 'rs123')
    expect(mergedSnp?.genotype).toBe('--')
    expect(result.conflicts[0].resolutionReason).toBe('Preferred File 1')
  })

  it('should sort by chromosome and position', async () => {
    const file1Snps = [
      { rsid: 'rs2', chromosome: '2', position: '200', genotype: 'AA', sourceFile: 1 as const },
      { rsid: 'rs1', chromosome: '1', position: '100', genotype: 'TT', sourceFile: 1 as const },
    ]

    const result = await mergeSnpsAsync(file1Snps, [], defaultOptions)

    expect(result.mergedSnps[0].rsid).toBe('rs1')
    expect(result.mergedSnps[1].rsid).toBe('rs2')
  })
})

describe('generateMyHeritageCsv', () => {
  it('should generate valid MyHeritage CSV format', async () => {
    const snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AA', sourceFile: 1 as const },
    ]

    const result = generateMyHeritageCsv(snps)

    expect(result.csv).toContain('##fileformat=MyHeritage')
    expect(result.csv).toContain('RSID,CHROMOSOME,POSITION,RESULT')
    expect(result.csv).toContain('"rs123","1","100","AA"')
    expect(result.excludedPAR).toBe(0)
  })

  it('should exclude XY (Pseudoautosomal) chromosomes', async () => {
    const snps = [
      { rsid: 'rs1', chromosome: 'X', position: '100', genotype: 'AA', sourceFile: 1 as const },
      { rsid: 'rs2', chromosome: 'XY', position: '200', genotype: 'TT', sourceFile: 1 as const },
      { rsid: 'rs3', chromosome: '25', position: '300', genotype: 'CC', sourceFile: 1 as const }, // Ancestry PAR format
      { rsid: 'rs4', chromosome: 'Y', position: '400', genotype: 'GG', sourceFile: 1 as const },
    ]

    const result = generateMyHeritageCsv(snps)

    expect(result.csv).toContain('"rs1"')
    expect(result.csv).not.toContain('"rs2"')
    expect(result.csv).not.toContain('"rs3"')
    expect(result.csv).toContain('"rs4"')
    expect(result.excludedPAR).toBe(2)
  })

  it('should include timestamp in header', async () => {
    const result = generateMyHeritageCsv([])
    expect(result.csv).toMatch(/##timestamp=.*UTC/)
  })
})

describe('generateAncestryCsv', () => {
  it('should generate valid Ancestry TXT format', async () => {
    const snps = [
      { rsid: 'rs123', chromosome: '1', position: '100', genotype: 'AA', sourceFile: 1 as const },
    ]

    const tsv = generateAncestryCsv(snps)

    expect(tsv).toContain('#AncestryDNA merged data')
    expect(tsv).toContain('rsid\tchromosome\tposition\tallele1\tallele2')
    expect(tsv).toContain('rs123\t1\t100\tA\tA')
  })

  it('should convert chromosomes to Ancestry numeric format', async () => {
    const snps = [
      { rsid: 'rs1', chromosome: 'X', position: '100', genotype: 'AA', sourceFile: 1 as const },
      { rsid: 'rs2', chromosome: 'Y', position: '200', genotype: 'TT', sourceFile: 1 as const },
      { rsid: 'rs3', chromosome: 'XY', position: '300', genotype: 'CC', sourceFile: 1 as const },
      { rsid: 'rs4', chromosome: 'MT', position: '400', genotype: 'GG', sourceFile: 1 as const },
    ]

    const tsv = generateAncestryCsv(snps)

    expect(tsv).toContain('rs1\t23\t100\tA\tA') // X → 23
    expect(tsv).toContain('rs2\t24\t200\tT\tT') // Y → 24
    expect(tsv).toContain('rs3\t25\t300\tC\tC') // XY → 25
    expect(tsv).toContain('rs4\t26\t400\tG\tG') // MT → 26
  })

  it('should split genotype into two alleles', async () => {
    const snps = [
      { rsid: 'rs456', chromosome: '2', position: '200', genotype: 'AC', sourceFile: 1 as const },
    ]

    const tsv = generateAncestryCsv(snps)

    expect(tsv).toContain('rs456\t2\t200\tA\tC')
  })

  it('should include timestamp in header', async () => {
    const tsv = generateAncestryCsv([])
    expect(tsv).toMatch(/#Generated by MergeDNA at:.*UTC/)
  })
})

describe('generateLogFile', () => {
  it('should generate log with conflicts and resolution reasons', async () => {
    const conflicts = [
      {
        rsid: 'rs123',
        chromosome: '1',
        position: '100',
        file1Genotype: 'AA',
        file2Genotype: 'AC',
        chosenGenotype: 'AA',
        resolutionReason: 'Preferred Ancestry',
      },
    ]

    const log = generateLogFile(conflicts, [])

    expect(log).toContain('DNA Merge Log')
    expect(log).toContain('CONFLICTS')
    expect(log).toContain('rs123')
    expect(log).toContain('Preferred Ancestry')
    expect(log).toContain('Resolution Reason')
  })

  it('should generate log with skipped rows', async () => {
    const skipped = [
      {
        lineNumber: 10,
        content: 'invalid line',
        reason: 'Invalid genotype',
        sourceFile: 1 as const,
      },
    ]

    const log = generateLogFile([], skipped)

    expect(log).toContain('SKIPPED ROWS')
    expect(log).toContain('invalid line')
    expect(log).toContain('Invalid genotype')
  })

  it('should include summary counts', async () => {
    const conflicts = [
      {
        rsid: 'rs1',
        chromosome: '1',
        position: '100',
        file1Genotype: 'AA',
        file2Genotype: 'AC',
        chosenGenotype: 'AA',
        resolutionReason: 'Preferred Ancestry',
      },
    ]
    const skipped = [{ lineNumber: 1, content: 'bad', reason: 'error', sourceFile: 1 as const }]

    const log = generateLogFile(conflicts, skipped)

    expect(log).toContain('Conflicts detected: 1')
    expect(log).toContain('Invalid rows skipped: 1')
  })
})

describe('normalizeGenotypeForFormat', () => {
  describe('converting to MyHeritage format', () => {
    it('should convert "0 0" to "--"', async () => {
      expect(normalizeGenotypeForFormat('0 0', 'myheritage')).toBe('--')
    })

    it('should convert "00" to "--"', async () => {
      expect(normalizeGenotypeForFormat('00', 'myheritage')).toBe('--')
    })

    it('should handle whitespace around "0 0"', async () => {
      expect(normalizeGenotypeForFormat(' 0 0 ', 'myheritage')).toBe('--')
    })

    it('should handle whitespace around "00"', async () => {
      expect(normalizeGenotypeForFormat(' 00 ', 'myheritage')).toBe('--')
    })

    it('should leave other genotypes unchanged', async () => {
      expect(normalizeGenotypeForFormat('AA', 'myheritage')).toBe('AA')
      expect(normalizeGenotypeForFormat('AT', 'myheritage')).toBe('AT')
      expect(normalizeGenotypeForFormat('CG', 'myheritage')).toBe('CG')
      expect(normalizeGenotypeForFormat('--', 'myheritage')).toBe('--')
      expect(normalizeGenotypeForFormat('DD', 'myheritage')).toBe('DD')
      expect(normalizeGenotypeForFormat('II', 'myheritage')).toBe('II')
    })
  })

  describe('converting to Ancestry format', () => {
    it('should convert "--" to "00"', async () => {
      expect(normalizeGenotypeForFormat('--', 'ancestry')).toBe('00')
    })

    it('should handle whitespace around "--"', async () => {
      expect(normalizeGenotypeForFormat(' -- ', 'ancestry')).toBe('00')
    })

    it('should leave other genotypes unchanged', async () => {
      expect(normalizeGenotypeForFormat('AA', 'ancestry')).toBe('AA')
      expect(normalizeGenotypeForFormat('AT', 'ancestry')).toBe('AT')
      expect(normalizeGenotypeForFormat('CG', 'ancestry')).toBe('CG')
      expect(normalizeGenotypeForFormat('00', 'ancestry')).toBe('00')
      expect(normalizeGenotypeForFormat('0 0', 'ancestry')).toBe('0 0')
      expect(normalizeGenotypeForFormat('DD', 'ancestry')).toBe('DD')
      expect(normalizeGenotypeForFormat('II', 'ancestry')).toBe('II')
    })
  })
})

describe('parseAncestryFile', () => {
  it('should parse ancestry file asynchronously', async () => {
    const result = await parseAncestryFileAsync(ANCESTRY_SAMPLE, 1)

    expect(result.snps).toHaveLength(5)
    expect(result.errors).toHaveLength(0)
    expect(result.format).toBe('ancestry')
  })

  it('should handle large files with batching', async () => {
    // Create a large file with 10,000 SNPs
    const header = `#AncestryDNA raw data download
rsid	chromosome	position	allele1	allele2
`
    const snpLines = Array.from({ length: 10000 }, (_, i) => `rs${i}\t1\t${1000 + i}\tA\tT`).join(
      '\n'
    )
    const largeFile = header + snpLines

    const result = await parseAncestryFileAsync(largeFile, 1)

    expect(result.snps).toHaveLength(10000)
    expect(result.format).toBe('ancestry')
    expect(result.errors).toHaveLength(0)
  })

  it('should validate and report errors asynchronously', async () => {
    const invalidContent = `#AncestryDNA raw data download
rsid	chromosome	position	allele1	allele2
rs123	1	100	A	T
rs456	99	200	C	G
rs789	1	300	X	Y`

    const result = await parseAncestryFileAsync(invalidContent, 1)

    expect(result.snps).toHaveLength(1) // Only first SNP is valid
    expect(result.errors).toHaveLength(2)
    expect(result.errors[0].reason).toContain('Invalid chromosome')
    expect(result.errors[1].reason).toContain('Invalid genotype')
  })

  it('should handle different chromosomes asynchronously', async () => {
    const content = `#AncestryDNA raw data download
rsid	chromosome	position	allele1	allele2
rs1	1	100	A	T
rs2	X	200	C	G
rs3	Y	300	G	G
rs4	MT	400	T	T
rs5	23	500	A	A`

    const result = await parseAncestryFileAsync(content, 1)

    expect(result.snps).toHaveLength(5)
    expect(result.snps.map(s => s.chromosome)).toEqual(['1', 'X', 'Y', 'MT', '23'])
  })
})

describe('parseMyHeritageFile', () => {
  it('should parse MyHeritage file asynchronously', async () => {
    const result = await parseMyHeritageFileAsync(MYHERITAGE_SAMPLE, 1)

    expect(result.snps).toHaveLength(5)
    expect(result.errors).toHaveLength(0)
    expect(result.format).toBe('myheritage')
  })

  it('should handle large files with batching', async () => {
    // Create a large file with 10,000 SNPs
    const header = `##fileformat=MyHeritage
##format=MHv1.0
RSID,CHROMOSOME,POSITION,RESULT
`
    const snpLines = Array.from(
      { length: 10000 },
      (_, i) => `"rs${i}","1","${1000 + i}","AT"`
    ).join('\n')
    const largeFile = header + snpLines

    const result = await parseMyHeritageFileAsync(largeFile, 1)

    expect(result.snps).toHaveLength(10000)
    expect(result.format).toBe('myheritage')
    expect(result.errors).toHaveLength(0)
  })

  it('should validate and report errors asynchronously', async () => {
    const invalidContent = `##fileformat=MyHeritage
RSID,CHROMOSOME,POSITION,RESULT
"rs123","1","100","AT"
"rs456","99","200","CG"
"rs789","1","300","XY"`

    const result = await parseMyHeritageFileAsync(invalidContent, 1)

    expect(result.snps).toHaveLength(1) // Only first SNP is valid
    expect(result.errors).toHaveLength(2)
    expect(result.errors[0].reason).toContain('Invalid chromosome')
    expect(result.errors[1].reason).toContain('Invalid genotype')
  })

  it('should handle different chromosomes asynchronously', async () => {
    const content = `##fileformat=MyHeritage
RSID,CHROMOSOME,POSITION,RESULT
"rs1","1","100","AT"
"rs2","X","200","CG"
"rs3","Y","300","GG"
"rs4","MT","400","TT"`

    const result = await parseMyHeritageFileAsync(content, 1)

    expect(result.snps).toHaveLength(4)
    expect(result.snps.map(s => s.chromosome)).toEqual(['1', 'X', 'Y', 'MT'])
  })

  it('should handle quoted CSV fields asynchronously', async () => {
    const content = `##fileformat=MyHeritage
RSID,CHROMOSOME,POSITION,RESULT
"rs3131972","1","752721","GG"
"rs114525117","1","759036","GG"`

    const result = await parseMyHeritageFileAsync(content, 1)

    expect(result.snps).toHaveLength(2)
    expect(result.snps[0].rsid).toBe('rs3131972')
    expect(result.snps[0].genotype).toBe('GG')
  })
})

describe('parseLivingDNAFile', () => {
  it('should parse LivingDNA file asynchronously', async () => {
    const result = await parseLivingDNAFileAsync(LIVINGDNA_SAMPLE, 1)

    expect(result.snps).toHaveLength(5)
    expect(result.format).toBe('livingdna')
    expect(result.chip).toBe('Sirius')
    expect(result.errors).toHaveLength(0)
  })

  it('should report progress with large dataset', async () => {
    // Create a large sample with 10000 lines to trigger progress reporting
    const largeLines = ['# Living DNA\n# rsid chromosome position genotype']
    for (let i = 0; i < 10000; i++) {
      largeLines.push(`rs${i} 1 ${i * 100} AT`)
    }
    const largeSample = largeLines.join('\n')

    const progressValues: number[] = []
    await parseLivingDNAFileAsync(largeSample, 1, p => progressValues.push(p))

    expect(progressValues.length).toBeGreaterThan(0)
  })
})
